"use strict";function onresize(e){var n=document.getElementById("body");n.scrollTop=n.scrollHeight;var t=document.getElementById("conversation-box");t.scrollTop=t.scrollHeight}function getOnlineCount(){$.getJSON(window.serverURI,function(e){$(".online-count>strong").text(e.usersOnline)})}window.serverURI="http://localhost:4000",window.onresize=onresize,window.onbeforeunload=function(){return"Are you sure you want to leave?"},getOnlineCount(),setInterval(getOnlineCount,5e3),window.chatBox=function(){function e(e){var n=s.attr("data-current");!0===e?(s.text("next"),s.attr("data-current","next"),s.removeClass("red")):"start"===n||"really"===n?(s.text("next"),s.attr("data-current","next"),s.removeClass("red"),chatClient.nextPartner()):(s.text("really?"),s.attr("data-current","really"),s.addClass("red"))}function n(){c.html(""),a.html("")}function t(){var n=a.val();if(chatClient.sendMessage(n)){var t=document.createTextNode(" "+n),o=$('<p class="userlog me"></p>');o.append('<span class="name">You</span>'),o.append(t),c.append(o),c.scrollTop(c.prop("scrollHeight")),a.val(""),e(!0)}}function o(e){var n=$('<div class="sys-info"></div>');switch(e){case"partner_connected":chatBox.clear(),n.append('<p class="syslog"><strong>You\'re now chatting with a random stranger. Say hi!</strong></p>');break;case"waiting_partner":n.append('<p class="syslog"><strong>Looking for someone you can talk to...</strong></p>');break;case"partner_disconnected":n.append('<p class="syslog"><strong>Sorry. stranger has disconnected.</strong></p>'),n.append('<p class="syslog"><strong>Click on <span class="special">next</span> to start a new chat.</strong></p>');break;case"server_disconnection":n.append('<p class="syslog error"><strong>System error! Please refresh this page!</strong></p>');break;default:n.append(e)}c.append(n),c.scrollTop(c.prop("scrollHeight"))}function r(e){var n=document.createTextNode(" "+e.content),t=$('<p class="userlog stranger"></p>');t.append('<span class="name">Stranger</span>'),t.append(n),c.append(t),c.scrollTop(c.prop("scrollHeight"))}var c=$(".conversation-box"),a=$(".write-box>textarea"),s=$("#control");return $(".write-box>.btn").on("click",t),s.on("click",e),a.on("keydown",function(e){13==e.which&&t()}),$(document).on("keyup",function(e){27==e.which&&s.click()}),{clear:n,writePartnerMessage:r,writeSytemInfo:o}}(),window.chatClient=function(){function e(){chatBox.clear(),o(),i.emit("next")}function n(){i.emit("info",{isVideoChat:p})}function t(){a("server_disconnection")}function o(){u=!1,m&&m.close&&m.close(),m=null,g=!1}function r(e){f=e,n(),w=!1,l instanceof HTMLVideoElement&&!l.srcObject&&(l.srcObject=e)}function c(e){f=null,n(),console.log(err),w=!1,--h>0&&setTimeout(getUserMediaDevices,1e3)}function a(e){switch(e){case"partner_connected":u=!0;break;case"partner_disconnected":o();break;case"waiting_partner":n(),u=!1}chatBox.writeSytemInfo(e)}function s(e){return!!(u&&e.replace(/\s+/g,"").length>0)&&(i.emit("msg",e),!0)}var i=io(window.serverURI),l=document.querySelector(".localVideo"),d=document.querySelector(".remoteVideo"),u=!1,p=!0,g=!1,f=null,m=void 0,h=5,w=!1,v={iceServers:[{urls:["stun:stun.l.google.com:19302"]}]},y={video:{facingMode:"user"}};return i.on("msg",chatBox.writePartnerMessage),i.on("sysinfo",a),i.on("ready",function(){console.log("Client is getting ready"),m=new RTCPeerConnection(v),m.addStream(l.srcObject),m.createOffer().then(function(e){return m.setLocalDescription(e)}).then(function(){console.log("client emitting offer",m.localDescription),i.emit("ready",m.localDescription)}),m.onaddstream=function(e){d.srcObject=e.stream,console.log("Setting remote video stream")},m.onicecandidate=function(e){e.candidate&&i.emit("candidate",e.candidate)}}),i.on("offer",function(e){var n=new RTCPeerConnection(v);l instanceof HTMLVideoElement&&n.addStream(l.srcObject),n.setRemoteDescription(e).then(function(){return n.createAnswer()}).then(function(e){return n.setLocalDescription(e)}).then(function(){i.emit("offer_ok",n.localDescription)}),n.onaddstream=function(e){d.srcObject=e.stream,console.log("Setting remote video stream")},n.onicecandidate=function(e){e.candidate&&i.emit("candidate",e.candidate)}}),i.on("answer",function(e){m&&m.setRemoteDescription(e)}),i.on("candidate",function(e){m&&m.addIceCandidate(new RTCIceCandidate(e))}),i.on("disconnect",t),function(){l instanceof HTMLVideoElement&&(l.srcObject?r(l.srcObject):w||l.srcObject||(w=!0,navigator.mediaDevices.getUserMedia(y).then(r).catch(c)))}(),{sendMessage:s,nextPartner:e}}();